name: PR Chack if Image is set in config

on:
  pull_request:
    branches:
      - "prerelease/**"
    types: [synchronize, opened]
  workflow_dispatch:

jobs:
  updateBody:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          submodules: true

      - name: Extract branch name
        shell: bash
        run: |
          TARGET_REF=""
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo ${{ github.base_ref }}
            TARGET_REF="${{ github.base_ref }}"
          else # For workflow_dispatch
            TARGET_REF="${{ github.ref }}" # GITHUB_REF is deprecated, github.ref is preferred
          fi
          BASE_NAME=${TARGET_REF##*/}
          # Remove any suffix starting with _ (e.g., my-addon_beta -> my-addon)
          echo "BR_VERSION=${BASE_NAME%%_*}" >> "$GITHUB_OUTPUT"
        id: extract_branch

      - name: ðŸ‘“ read-yaml-file ${{ steps.extract_branch.outputs.BR_VERSION }}/config.yaml
        uses: pietrobolcato/action-read-yaml@9f13718d61111b69f30ab4ac683e67a56d254e1d # 1.1.0
        id: read_action_js
        with:
          config: ${{ github.workspace }}/${{ steps.extract_branch.outputs.BR_VERSION }}/config.yaml

      - name: Check image in yaml config of ${{ steps.extract_branch.outputs.BR_VERSION }}
        if: ${{ steps.read_action_js.outputs.image == '' }}
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            core.setFailed('Image in yaml config of ${{ steps.extract_branch.outputs.BR_VERSION }} is not set!')
